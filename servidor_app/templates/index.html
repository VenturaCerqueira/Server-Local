<!doctype html>
<html lang="pt-br">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dashboard do Servidor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        :root {
            --sidebar-width: 250px;
            --sidebar-width-collapsed: 0px;
            --navbar-height: 56px;

            /* Paleta de Cores - Light Mode (Azul) */
            --primary-color: #0d6efd;
            --primary-color-light: #e7f1ff;
            --primary-color-dark: #0747a6;
            --text-color: #212529;
            --text-color-muted: #6c757d;
            --bg-color: #f0f4f9;
            --card-bg-color: #fff;
            --card-shadow: 0 1px 2px 0 rgba(0,0,0,0.1);
            --border-color: #d1d5db;
            --link-hover-bg: #e2eafb;
            --header-bg-color: #fff;
            transition: color 0.3s ease, background-color 0.3s ease;
        }

        .dark-mode {
            /* Paleta de Cores - Dark Mode (Branco) */
            --primary-color: #5d9aff;
            --primary-color-light: #2c4466;
            --primary-color-dark: #8ab4f8;
            --text-color: #e8e8e8;
            --text-color-muted: #adb5bd;
            --bg-color: #1a202c;
            --card-bg-color: #2d3748;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            --border-color: #4a5568;
            --link-hover-bg: #3c4961;
            --header-bg-color: #2d3748;

            a {
                color: var(--text-color);
            }
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            padding-top: var(--navbar-height);
            margin-left: var(--sidebar-width);
            transition: margin-left 0.3s ease;
        }
        .body-collapsed {
            margin-left: var(--sidebar-width-collapsed);
        }
        .navbar {
            height: var(--navbar-height);
            background-color: var(--header-bg-color);
            border-bottom: 1px solid var(--border-color);
        }
        .navbar-brand, .navbar-toggler-icon, .nav-link {
            color: var(--text-color);
        }
        .navbar-brand:hover {
            color: var(--primary-color);
        }
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--card-bg-color);
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            position: fixed;
            top: var(--navbar-height);
            left: 0;
            bottom: 0;
            overflow-y: auto;
            transition: width 0.3s ease;
            border-right: 1px solid var(--border-color);
        }
        .body-collapsed .sidebar {
            width: var(--sidebar-width-collapsed);
            overflow: hidden;
            padding: 0;
        }
        .sidebar-content {
            white-space: nowrap;
            opacity: 1;
            transition: opacity 0.3s ease;
        }
        .body-collapsed .sidebar-content {
            opacity: 0;
        }

        .main-content-area {
            padding: 20px;
            flex-grow: 1;
        }
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .card-elegant {
            background: var(--card-bg-color);
            border-radius: 1rem;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
        }

        /* Estilos para o modo de lista */
        .list-group-item {
            background-color: var(--card-bg-color);
            color: var(--text-color);
            border-color: var(--border-color);
            transition: background-color 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
        }
        .list-group-item:hover {
            background-color: var(--link-hover-bg);
        }
        
        .list-item-link {
            display: flex;
            align-items: center;
            flex-grow: 1;
            min-width: 0;
            text-decoration: none;
            color: inherit;
        }
        .list-item-link:hover {
            color: var(--primary-color);
        }
        
        .item-actions-container {
            display: flex;
            align-items: center;
            flex-shrink: 0;
            gap: 0.5rem; /* Reduzido o gap para botões mais próximos */
        }

        /* Estilos para o modo de grade (Google Drive) */
        .grid-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1rem;
        }
        .grid-item-card {
            background-color: var(--card-bg-color);
            border-radius: 0.5rem;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: box-shadow 0.2s ease;
            overflow: hidden; 
        }
        .grid-item-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .grid-item-preview {
            height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-color);
            border-bottom: 1px solid var(--border-color);
        }
        .grid-item-preview a {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            text-decoration: none;
        }
        .grid-item-preview .preview-icon {
            font-size: 4rem;
            color: var(--text-color-muted);
        }
        .grid-item-info {
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .grid-item-info .item-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }
        .grid-item-filename {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
        }
        .grid-item-actions .dropdown-toggle::after {
            display: none; 
        }
        .grid-item-actions .btn {
            color: var(--text-color-muted);
        }
        .grid-item-actions .btn:hover {
            color: var(--text-color);
            background-color: var(--link-hover-bg);
        }
        .grid-item-actions .dropdown-menu {
             background-color: var(--card-bg-color);
             border: 1px solid var(--border-color);
             box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .grid-item-actions .dropdown-item {
            color: var(--text-color);
            font-size: 0.9rem;
        }
        .grid-item-actions .dropdown-item:hover {
             background-color: var(--link-hover-bg);
        }
        .grid-item-actions .dropdown-item i {
            width: 20px;
            text-align: center;
        }


        /* Estilos da barra de filtros */
        .filter-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .filter-bar .dropdown-toggle {
            background-color: var(--card-bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            box-shadow: none;
        }
        .filter-bar .dropdown-toggle:hover {
            background-color: var(--link-hover-bg);
            border-color: var(--primary-color-light);
        }
        .filter-bar .dropdown-toggle:focus {
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
            border-color: var(--primary-color);
        }
        .filter-bar .dropdown-menu {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            box-shadow: var(--card-shadow);
        }
        .filter-bar .dropdown-item {
            color: var(--text-color);
        }
        .filter-bar .dropdown-item:hover {
            background-color: var(--link-hover-bg);
            color: var(--primary-color);
        }

        /* Estilos gerais */
        .sidebar .nav-link {
            color: var(--text-color);
            font-weight: 500;
        }
        .sidebar .nav-link.active {
            background-color: var(--primary-color-light);
            color: var(--primary-color);
            border-radius: 0.5rem;
        }
        .navbar-brand {
            font-weight: bold;
        }
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .btn-primary:hover {
            background-color: var(--primary-color-dark);
            border-color: var(--primary-color-dark);
        }
        .progress-bar {
            background-color: var(--primary-color);
        }
        .text-blue {
            color: var(--primary-color) !important;
        }
        .dark-mode .text-primary {
            color: var(--primary-color) !important;
        }
        .text-primary {
             color: var(--primary-color) !important;
        }

        .text-muted, .text-muted .small {
            color: var(--text-color-muted) !important;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            transition: opacity 0.3s ease;
            opacity: 0;
            visibility: hidden;
        }
        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
            display: flex;
        }

        /* Estilos do Modal de Busca */
        .search-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 600px;
            background: var(--card-bg-color);
            border-radius: 0.75rem;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            z-index: 10000;
            display: none;
            flex-direction: column;
            max-height: 80vh;
            overflow: hidden;
        }
        .search-modal.show {
            display: flex;
        }
        .search-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            display: none;
        }
        .search-overlay.show {
            display: block;
        }
        .search-input-group {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        .search-input-group input {
            border: none;
            background: none;
            color: var(--text-color);
        }
        .search-input-group input:focus {
            box-shadow: none;
        }
        .search-results {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-y: auto;
            flex-grow: 1;
        }
        .search-results-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1rem;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
        }
        .search-results-item:hover {
            background-color: var(--link-hover-bg);
            color: var(--text-color);
        }
        .search-results-item small {
            color: var(--text-color-muted);
        }
        .search-shortcut {
            font-size: 0.8rem;
            color: var(--text-color-muted);
            border: 1px solid var(--border-color);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .empty-folder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-color-muted);
        }

        .empty-folder i {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        /* Estilos Personalizados para os Modals */
        .modal-content.card-elegant-upload, .modal-content {
            background-color: var(--card-bg-color);
            border-radius: 1rem;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
        }

        .modal-header-upload, .modal-header {
            background-color: var(--primary-color-light);
            color: var(--primary-color);
            border-bottom: 1px solid var(--primary-color);
            padding: 1.5rem;
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
        }

        .modal-header-upload .btn-close, .modal-header .btn-close {
            color: var(--primary-color);
            opacity: 0.7;
        }

        .modal-header-upload .btn-close:hover, .modal-header .btn-close:hover {
            opacity: 1;
        }

        .modal-title-upload, .modal-title {
            font-weight: bold;
            margin-bottom: 0;
        }

        .modal-body-upload, .modal-body {
            padding: 2rem;
        }

        .modal-footer-upload, .modal-footer {
            border-top: 1px solid var(--border-color);
            padding: 1rem;
            display: flex;
            justify-content: flex-end;
            border-bottom-left-radius: 1rem;
            border-bottom-right-radius: 1rem;
        }

        .form-label-upload {
            color: var(--text-color);
            font-weight: bold;
            margin-bottom: 0.5rem;
            display: block;
        }

        .form-control-upload {
            display: block;
            width: 100%;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: var(--text-color);
            background-color: var(--bg-color);
            background-clip: padding-box;
            border: 1px solid var(--border-color);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border-radius: 0.5rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .form-control-upload:focus {
            color: var(--text-color);
            background-color: var(--bg-color);
            border-color: var(--primary-color);
            outline: 0;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        .btn-secondary-upload {
            color: var(--text-color-muted);
            background-color: transparent;
            border-color: var(--border-color);
        }

        .btn-secondary-upload:hover {
            color: var(--text-color);
            background-color: var(--link-hover-bg);
            border-color: var(--border-color);
        }

        .btn-primary-upload {
            color: #fff;
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            transition: background-color 0.15s ease-in-out, border-color 0.15s ease-in-out;
        }

        .btn-primary-upload:hover {
            color: #fff;
            background-color: var(--primary-color-dark);
            border-color: var(--primary-color-dark);
        }

        .spinner-border-upload {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            vertical-align: text-bottom;
            border: 0.2em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            -webkit-animation: spinner-border .75s linear infinite;
            animation: spinner-border .75s linear infinite;
        }

        @-webkit-keyframes spinner-border {
            to { -webkit-transform: rotate(360deg); transform: rotate(360deg); }
        }

        @keyframes spinner-border {
            to { -webkit-transform: rotate(360deg); transform: rotate(360deg); }
        }

        .fab-upload {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            border: none;
            cursor: pointer;
            z-index: 1000;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .fab-upload:hover {
            background-color: var(--primary-color-dark);
            transform: scale(1.05);
        }
        
        .sidebar .btn-novo {
            width: 100%;
            text-align: left;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            background-color: var(--primary-color);
            color: #fff;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: background-color 0.2s ease;
        }
        .sidebar .btn-novo:hover {
            background-color: var(--primary-color-dark);
        }
        .sidebar .dropdown-menu {
            border-radius: 0.5rem;
            box-shadow: var(--card-shadow);
            background-color: var(--card-bg-color);
        }
        .sidebar .dropdown-item {
            color: var(--text-color);
        }
        .sidebar .dropdown-item:hover {
            background-color: var(--link-hover-bg);
            color: var(--primary-color);
        }
    </style>
</head>
<body>
    
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Carregando...</span>
        </div>
    </div>

    <div id="search-overlay" class="search-overlay"></div>
    <div id="search-modal" class="search-modal">
        <div class="search-input-group">
            <i class="bi bi-search me-2" style="font-size: 1.25rem; color: var(--text-color-muted);"></i>
            <input type="text" id="search-input" class="form-control" placeholder="Buscar arquivos e pastas..." autofocus>
            <span class="search-shortcut ms-2">Ctrl K</span>
        </div>
        <div class="search-results-container">
            <ul id="search-results-list" class="search-results">
            </ul>
        </div>
    </div>

    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container-fluid">
            <button class="btn btn-link me-2" id="sidebar-toggle" style="color: var(--primary-color);">
                <i class="bi bi-list"></i>
            </button>
            <a class="navbar-brand nav-link-loader" href="/">
                <i class="bi bi-cloud-haze me-2"></i>Servidor de Arquivos
            </a>
            <div class="ms-auto">
                <button class="btn btn-link me-2" id="layout-toggle" style="color: var(--text-color);">
                    <i class="bi bi-grid-3x3-gap"></i>
                </button>
                <button class="btn btn-link me-2" id="search-toggle" style="color: var(--text-color);">
                    <i class="bi bi-search"></i>
                </button>
                <button class="btn btn-link" id="theme-toggle" style="color: var(--text-color);">
                    <i class="bi bi-sun"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-content">
                <div class="dropdown mb-4">
                    <button class="btn btn-primary btn-novo dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-plus-lg"></i> Novo
                    </button>
                    <ul class="dropdown-menu">
                        <li>
                            <button class="dropdown-item" type="button" data-bs-toggle="modal" data-bs-target="#newFolderModal">
                                <i class="bi bi-folder-plus me-2"></i> Nova Pasta
                            </button>
                        </li>
                        <li>
                            <button class="dropdown-item" type="button" data-bs-toggle="modal" data-bs-target="#uploadModal">
                                <i class="bi bi-file-earmark-plus me-2"></i> Novo Arquivo
                            </button>
                        </li>
                    </ul>
                </div>
                
                <h4 class="fw-bold text-blue mb-4">Navegação</h4>
                <div class="nav flex-column nav-pills">
                    <a class="nav-link active nav-link-loader" href="/">
                        <i class="bi bi-folder me-2"></i>Meus Arquivos
                    </a>
                </div>
                <hr>
                <h4 class="fw-bold text-blue mb-4">Status</h4>
                <ul class="list-unstyled">
                    <li>
                        <p class="mb-1 fw-bold">Memória</p>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar" role="progressbar" id="memory-progress"style="width: {{ dados_servidor.memory_percent }}%;"></div>
                        </div>
                        <span class="small text-muted">{{ dados_servidor.memory_percent }}% de {{ dados_servidor.total_memory_gb }} GB</span>
                    </li>
                    <li class="mt-3">
                        <p class="mb-1 fw-bold">Disco (W:)</p>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar" role="progressbar"
style="width: {{ dados_servidor.disk_percent }}%;"></div>
                        </div>
                        <span class="small text-muted">{{ dados_servidor.disk_percent }}% de {{ dados_servidor.total_disk_gb }} GB</span>
                    </li>
                </ul>
            </div>
        </div>

        <div class="main-content-area" id="main-content">
            <div class="content-header">
                <h2 class="fw-bold mb-0">
                    <i class="bi bi-folder me-2"></i>
                    {% if current_path %}
                        {{ current_path.rsplit('/', 1)[-1] }}
                    {% else %}
                        Meus Arquivos
                    {% endif %}
                </h2>
                <div>
                    {% if current_path %}
                        <a href="{% if parent_path %}/browse/{{ parent_path }}{% else %}/{% endif %}" class="btn btn-primary nav-link-loader">
                            <i class="bi bi-arrow-left me-1"></i> Voltar
                        </a>
                    {% endif %}
                </div>
            </div>

            <div class="filter-bar mb-4">
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-filter me-2"></i>Tipo
                    </button>
                    <ul class="dropdown-menu" id="filter-type">
                        <li><a class="dropdown-item" href="#" data-filter-type="all">Todos</a></li>
                        <li><a class="dropdown-item" href="#" data-filter-type="dir"><i class="bi bi-folder-fill me-2"></i>Pastas</a></li>
                        <li><a class="dropdown-item" href="#" data-filter-type="image"><i class="bi bi-file-earmark-image-fill me-2"></i>Imagens</a></li>
                        <li><a class="dropdown-item" href="#" data-filter-type="pdf"><i class="bi bi-filetype-pdf me-2"></i>PDFs</a></li>
                        <li><a class="dropdown-item" href="#" data-filter-type="document"><i class="bi bi-filetype-doc me-2"></i>Documentos</a></li>
                        <li><a class="dropdown-item" href="#" data-filter-type="zip"><i class="bi bi-file-earmark-zip-fill me-2"></i>Zip</a></li>
                    </ul>
                </div>
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-clock me-2"></i>Alteração
                    </button>
                    <ul class="dropdown-menu" id="filter-date">
                        <li><a class="dropdown-item" href="#" data-filter-date="all">Qualquer Data</a></li>
                        <li><a class="dropdown-item" href="#" data-filter-date="today">Hoje</a></li>
                        <li><a class="dropdown-item" href="#" data-filter-date="week">Últimos 7 dias</a></li>
                        <li><a class="dropdown-item" href="#" data-filter-date="month">Últimos 30 dias</a></li>
                    </ul>
                </div>
            </div>
            
            <div id="file-system-view" class="card-elegant p-4">
                <div id="file-list-container" class="list-group list-group-flush">
                    </div>
            </div>
        </div>
    </div>

    <button class="fab-upload" data-bs-toggle="modal" data-bs-target="#uploadModal">
        <i class="bi bi-plus-lg"></i>
    </button>

    <div class="modal fade" id="propertiesModal" tabindex="-1" aria-labelledby="propertiesModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="propertiesModalLabel">Propriedades</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-borderless">
                        <tbody>
                            <tr><th scope="row" class="w-25">Nome:</th><td id="prop-name"></td></tr>
                            <tr><th scope="row">Tipo:</th><td id="prop-type"></td></tr>
                            <tr id="file-size-row" style="display: none;">
                                <th scope="row">Tamanho:</th><td id="prop-size"></td>
                            </tr>
                            <tr id="file-size-bytes-row" style="display: none;">
                                <th scope="row">Tamanho (bytes):</th><td id="prop-size-bytes"></td>
                            </tr>
                            <tr id="folder-count-row" style="display: none;">
                                <th scope="row">Conteúdo:</th><td id="prop-counts"></td>
                            </tr>
                            <tr><th scope="row">Modificado em:</th><td id="prop-modified"></td></tr>
                            <tr><th scope="row">Criado em:</th><td id="prop-created"></td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('main.logout') }}">
                                <i class="bi bi-box-arrow-right"></i>
                                <span>Sair</span>
                            </a>
                        </li>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content card-elegant-upload">
                <div class="modal-header modal-header-upload">
                    <h5 class="modal-title modal-title-upload" id="uploadModalLabel">Upload de Arquivo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="upload-form" action="/upload" method="POST" enctype="multipart/form-data">
                    <div class="modal-body modal-body-upload">
                        <input type="hidden" id="current-path-input" name="current_path" value="{{ current_path }}">
                        <div class="mb-3">
                            <label for="file-input" class="form-label form-label-upload">Selecione o arquivo para upload</label>
                            <input class="form-control form-control-upload" type="file" id="file-input" name="file" required>
                        </div>
                    </div>
                    <div class="modal-footer modal-footer-upload">
                        <button type="button" class="btn btn-secondary btn-secondary-upload" data-bs-dismiss="modal">Fechar</button>
                        <button type="submit" class="btn btn-primary btn-primary-upload" id="upload-btn">
                            <span id="upload-spinner" class="spinner-border spinner-border-sm me-2 spinner-border-upload" role="status" aria-hidden="true" style="display: none;"></span>
                            Fazer Upload
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="newFolderModal" tabindex="-1" aria-labelledby="newFolderModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content card-elegant-upload">
                <div class="modal-header modal-header-upload">
                    <h5 class="modal-title modal-title-upload" id="newFolderModalLabel">Criar Nova Pasta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="new-folder-form">
                    <div class="modal-body modal-body-upload">
                        <input type="hidden" id="new-folder-path-input" name="current_path" value="{{ current_path }}">
                        <div class="mb-3">
                            <label for="folder-name-input" class="form-label form-label-upload">Nome da nova pasta</label>
                            <input type="text" class="form-control form-control-upload" id="folder-name-input" name="folder_name" required>
                        </div>
                    </div>
                    <div class="modal-footer modal-footer-upload">
                        <button type="button" class="btn btn-secondary btn-secondary-upload" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary btn-primary-upload" id="create-folder-btn">
                            <span id="create-folder-spinner" class="spinner-border spinner-border-sm me-2 spinner-border-upload" role="status" aria-hidden="true" style="display: none;"></span>
                            Criar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const pastasData = JSON.parse('{{ pastas | tojson | safe }}');
        const allFiles = Array.isArray(pastasData) ? pastasData : [];
        let currentFilteredFiles = [...allFiles];
        let currentLayout = localStorage.getItem('layout') || 'list';
        let currentFilters = { type: 'all', date: 'all' };

        document.addEventListener('DOMContentLoaded', function () {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const mainContent = document.getElementById('main-content');
            const loadingOverlay = document.getElementById('loading-overlay');
            const searchModal = document.getElementById('search-modal');
            const searchOverlay = document.getElementById('search-overlay');
            const searchToggle = document.getElementById('search-toggle');
            const searchInput = document.getElementById('search-input');
            const searchResultsList = document.getElementById('search-results-list');
            const propertiesModal = document.getElementById('propertiesModal');
            const fileSystemView = document.getElementById('file-system-view');
            const fileListContainer = document.getElementById('file-list-container');
            const layoutToggle = document.getElementById('layout-toggle');
            
            let isSidebarCollapsed = false;

            // Lógica do Sidebar
            const updateSidebarState = () => {
                if (isSidebarCollapsed) {
                    document.body.classList.add('body-collapsed');
                } else {
                    document.body.classList.remove('body-collapsed');
                }
            };
            
            sidebarToggle.addEventListener('click', () => {
                isSidebarCollapsed = !isSidebarCollapsed;
                updateSidebarState();
            });

            // Lógica do Layout
            const applyLayout = (layout) => {
                const icon = layoutToggle.querySelector('i');
                if (layout === 'grid') {
                    fileListContainer.classList.remove('list-group', 'list-group-flush');
                    fileListContainer.classList.add('grid-view');
                    icon.className = 'bi bi-list';
                } else {
                    fileListContainer.classList.remove('grid-view');
                    fileListContainer.classList.add('list-group', 'list-group-flush');
                    icon.className = 'bi bi-grid-3x3-gap';
                }
                localStorage.setItem('layout', layout);
                renderFiles(currentFilteredFiles);
            };

            layoutToggle.addEventListener('click', () => {
                const newLayout = currentLayout === 'grid' ? 'list' : 'grid';
                currentLayout = newLayout;
                applyLayout(newLayout);
            });

            const renderFiles = (files) => {
                fileListContainer.innerHTML = ''; 
                if (files.length === 0) {
                    fileListContainer.innerHTML = `
                        <div class="empty-folder">
                            <i class="bi bi-box-seam"></i>
                            <p class="mb-0">Nenhum item encontrado com os filtros selecionados.</p>
                        </div>
                    `;
                    return;
                }
                
                files.forEach(item => {
                    const itemElement = document.createElement('div');
                    
                    const isGrid = currentLayout === 'grid';
                    if (isGrid) {
                        itemElement.classList.add('grid-item-card');
                    } else {
                        itemElement.classList.add('list-group-item', 'px-0', 'list-item');
                    }

                    let iconClass;
                    let iconColor = 'var(--text-color)';
                    if (item.is_dir) {
                        iconClass = 'bi-folder-fill';
                        iconColor = 'var(--primary-color)';
                    } else {
                        switch (item.type) {
                            case 'pdf': iconClass = 'bi-filetype-pdf'; iconColor = '#dc3545'; break;
                            case 'doc': case 'docx': case 'txt': iconClass = 'bi-filetype-doc'; iconColor = '#007bff'; break;
                            case 'jpg': case 'jpeg': case 'png': case 'gif': case 'svg': iconClass = 'bi-file-earmark-image-fill'; iconColor = '#28a745'; break;
                            case 'zip': iconClass = 'bi-file-earmark-zip-fill'; iconColor = '#17a2b8'; break;
                            default: iconClass = 'bi-file-earmark-text-fill'; iconColor = '#6c757d'; break;
                        }
                    }

                    if (isGrid) {
                        itemElement.innerHTML = `
                            <div class="grid-item-preview">
                                <a href="${item.is_dir ? '/browse/' + item.path : '#'}" class="nav-link-loader">
                                    <i class="bi ${iconClass} preview-icon" style="color: ${iconColor};"></i>
                                </a>
                            </div>
                            <div class="grid-item-info">
                                <i class="bi ${iconClass} item-icon" style="color: ${iconColor};"></i>
                                <span class="grid-item-filename">${item.nome}</span>
                                <div class="dropdown grid-item-actions">
                                    <button class="btn btn-sm btn-link dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bi bi-three-dots-vertical"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li>
                                            <a class="dropdown-item" href="/download/${item.path}">
                                                <i class="bi bi-download me-2"></i>Download
                                            </a>
                                        </li>
                                        <li>
                                            <button class="dropdown-item" type="button" data-bs-toggle="modal" data-bs-target="#propertiesModal"
                                                data-name="${item.nome}" data-modified="${item.modified_at}" data-created="${item.created_at}" data-type="${item.is_dir ? 'Pasta' : 'Arquivo'}"
                                                data-file-count="${item.file_count}" data-folder-count="${item.folder_count}"
                                                data-size="${item.size}" data-size-bytes="${item.size_bytes}" data-file-type="${item.type}">
                                                <i class="bi bi-info-circle me-2"></i>Propriedades
                                            </button>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        `;
                    } else {
                        // AJUSTE: Botões padronizados e nome do item em azul
                        itemElement.innerHTML = `
                            <a href="${item.is_dir ? '/browse/' + item.path : '#'}" class="list-item-link nav-link-loader">
                                <i class="bi ${iconClass} me-3 fs-5" style="color: ${iconColor};"></i>
                                <span class="d-flex flex-column me-auto">
                                    <span class="fw-bold text-primary">${item.nome}</span>
                                    <small class="text-muted folder-size-placeholder">
                                        ${item.is_dir ? `${item.file_count} arquivos, ${item.folder_count} pastas` : item.size}
                                    </small>
                                </span>
                            </a>
                            <div class="item-actions-container">
                                <a href="/download/${item.path}" class="btn btn-outline-primary btn-sm">
                                    <i class="bi bi-download"></i> Baixar
                                </a>
                                <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#propertiesModal"
                                    data-name="${item.nome}" data-modified="${item.modified_at}" data-created="${item.created_at}" data-type="${item.is_dir ? 'Pasta' : 'Arquivo'}"
                                    data-file-count="${item.file_count}" data-folder-count="${item.folder_count}"
                                    data-size="${item.size}" data-size-bytes="${item.size_bytes}" data-file-type="${item.type}">
                                    <i class="bi bi-info-circle"></i> Info
                                </button>
                            </div>
                        `;
                    }
                    fileListContainer.appendChild(itemElement);
                });
            };

            const filterFiles = () => {
                currentFilteredFiles = allFiles.filter(item => {
                    const typeMatch = (currentFilters.type === 'all' || 
                                       (currentFilters.type === 'dir' && item.is_dir) ||
                                       (currentFilters.type === 'document' && (item.type === 'doc' || item.type === 'docx' || item.type === 'txt')) ||
                                       (item.is_dir === false && item.type === currentFilters.type));

                    if (!typeMatch) return false;

                    const today = new Date();
                    // Assumindo que a data vem no formato DD/MM/YYYY HH:mm
                    const dateParts = item.modified_at.split(' ')[0].split('/');
                    const itemDate = new Date(`${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`);
                    const diffTime = today - itemDate;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    if (currentFilters.date === 'all') return true;
                    if (currentFilters.date === 'today' && diffDays <= 1) return true;
                    if (currentFilters.date === 'week' && diffDays <= 7) return true;
                    if (currentFilters.date === 'month' && diffDays <= 30) return true;

                    return false;
                });
                renderFiles(currentFilteredFiles);
            };

            // Event Listeners para os filtros
            document.querySelectorAll('#filter-type .dropdown-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentFilters.type = e.target.getAttribute('data-filter-type');
                    filterFiles();
                });
            });

            document.querySelectorAll('#filter-date .dropdown-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentFilters.date = e.target.getAttribute('data-filter-date');
                    filterFiles();
                });
            });

            document.body.addEventListener('click', function(e) {
                const link = e.target.closest('.nav-link-loader');
                if (link) {
                    const href = link.getAttribute('href');
                    if (href && href !== '#') {
                        e.preventDefault();
                        loadingOverlay.classList.add('show');
                        window.location.href = href;
                    }
                }
            });

            // AJUSTE: Event listener do modal para exibir todas as novas informações
            propertiesModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const name = button.getAttribute('data-name');
                const type = button.getAttribute('data-type');
                const size = button.getAttribute('data-size');
                const sizeBytes = button.getAttribute('data-size-bytes');
                const modified = button.getAttribute('data-modified');
                const created = button.getAttribute('data-created');
                const fileCount = button.getAttribute('data-file-count');
                const folderCount = button.getAttribute('data-folder-count');
                
                document.getElementById('prop-name').textContent = name;
                document.getElementById('prop-type').textContent = type;
                document.getElementById('prop-modified').textContent = modified;
                document.getElementById('prop-created').textContent = created;
                
                const fileSizeRow = document.getElementById('file-size-row');
                const fileSizeInBytesRow = document.getElementById('file-size-bytes-row');
                const folderCountRow = document.getElementById('folder-count-row');
                
                if (type === 'Arquivo') {
                    fileSizeRow.style.display = '';
                    fileSizeInBytesRow.style.display = '';
                    folderCountRow.style.display = 'none';
                    document.getElementById('prop-size').textContent = size;
                    document.getElementById('prop-size-bytes').textContent = `${sizeBytes} bytes`;
                } else {
                    fileSizeRow.style.display = 'none';
                    fileSizeInBytesRow.style.display = 'none';
                    folderCountRow.style.display = '';
                    document.getElementById('prop-counts').textContent = `${fileCount} arquivos, ${folderCount} pastas`;
                }
            });

            // Lidar com o botão de pesquisa
            const showSearchModal = () => {
                searchModal.classList.add('show');
                searchOverlay.classList.add('show');
                searchInput.focus();
            };

            const hideSearchModal = () => {
                searchModal.classList.remove('show');
                searchOverlay.classList.remove('show');
                searchInput.value = '';
                searchResultsList.innerHTML = '';
            };

            searchToggle.addEventListener('click', showSearchModal);
            searchOverlay.addEventListener('click', hideSearchModal);
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'k') {
                    e.preventDefault();
                    showSearchModal();
                }
                if (e.key === 'Escape') {
                    hideSearchModal();
                }
            });

            // Lidar com a pesquisa
            let searchTimeout;
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                const query = searchInput.value;
                if (query.length > 1) {
                    searchTimeout = setTimeout(async () => {
                        const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
                        const results = await response.json();
                        searchResultsList.innerHTML = '';
                        if (results.length > 0) {
                            results.forEach(item => {
                                const li = document.createElement('li');
                                
                                let iconClass;
                                let iconColor = 'var(--text-color)';
                                if (item.is_dir) {
                                    iconClass = 'bi-folder-fill';
                                } else {
                                    const fileExtension = item.nome.split('.').pop().toLowerCase();
                                    switch (fileExtension) {
                                        case 'pdf': iconClass = 'bi-filetype-pdf'; iconColor = '#dc3545'; break;
                                        case 'doc': case 'docx': iconClass = 'bi-filetype-doc'; iconColor = '#007bff'; break;
                                        case 'txt': iconClass = 'bi-filetype-txt'; iconColor = '#6c757d'; break;
                                        case 'jpg': case 'jpeg': case 'png': case 'gif': case 'svg': iconClass = 'bi-file-earmark-image-fill'; iconColor = '#28a745'; break;
                                        case 'zip': iconClass = 'bi-file-earmark-zip-fill'; iconColor = '#17a2b8'; break;
                                        default: iconClass = 'bi-file-earmark-text-fill'; break;
                                    }
                                }

                                li.innerHTML = `
                                <a href="${item.is_dir ? '/browse/' + item.path : '/download/' + item.path}" class="search-results-item nav-link-loader">
                                    <i class="bi ${iconClass} me-3 fs-5" style="color: ${iconColor};"></i>
                                    <span class="d-flex flex-column me-auto">
                                        <span class="fw-bold">${item.nome}</span>
                                        <small class="text-muted">${item.path}</small>
                                    </span>
                                </a>
                                `;
                                searchResultsList.appendChild(li);
                            });
                        } else {
                            searchResultsList.innerHTML = `<li class="list-group-item text-muted p-3">Nenhum resultado encontrado.</li>`;
                        }
                    }, 300);
                } else {
                    searchResultsList.innerHTML = '';
                }
            });

            // Lidar com o tema claro/escuro
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = themeToggle.querySelector('i');
            const isDarkMode = localStorage.getItem('dark-mode') === 'true';

            const applyTheme = (isDark) => {
                if (isDark) {
                    document.body.classList.add('dark-mode');
                    themeIcon.className = 'bi bi-moon-fill';
                } else {
                    document.body.classList.remove('dark-mode');
                    themeIcon.className = 'bi bi-sun-fill';
                }
            };

            applyTheme(isDarkMode);

            themeToggle.addEventListener('click', () => {
                const newTheme = document.body.classList.toggle('dark-mode');
                localStorage.setItem('dark-mode', newTheme);
                applyTheme(newTheme);
            });

            // Renderização inicial
            applyLayout(currentLayout);
            if (allFiles && allFiles.length > 0) {
                renderFiles(allFiles);
            }
        });

        document.getElementById('upload-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const form = e.target;
            const formData = new FormData(form);
            const uploadBtn = document.getElementById('upload-btn');
            const spinner = document.getElementById('upload-spinner');

            spinner.style.display = 'inline-block';
            uploadBtn.disabled = true;

            try {
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData,
                });
                const result = await response.json();

                if (response.ok) {
                    window.location.href = result.redirect_url;
                } else {
                    alert('Erro no upload: ' + result.message);
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro na conexão com o servidor.');
            } finally {
                spinner.style.display = 'none';
                uploadBtn.disabled = false;
            }
        });

        document.getElementById('new-folder-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const form = e.target;
            const folderName = document.getElementById('folder-name-input').value;
            const currentPath = document.getElementById('new-folder-path-input').value;
            const createFolderBtn = document.getElementById('create-folder-btn');
            const spinner = document.getElementById('create-folder-spinner');
            
            spinner.style.display = 'inline-block';
            createFolderBtn.disabled = true;

            try {
                const response = await fetch('/create_folder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        folder_name: folderName,
                        current_path: currentPath
                    }),
                });
                const result = await response.json();

                if (response.ok) {
                    window.location.href = result.redirect_url;
                } else {
                    alert('Erro ao criar pasta: ' + result.message);
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro na conexão com o servidor.');
            } finally {
                spinner.style.display = 'none';
                createFolderBtn.disabled = false;
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            const currentPathInput = document.getElementById('current-path-input');
            const newFolderPathInput = document.getElementById('new-folder-path-input');
            const pathSegments = window.location.pathname.split('/browse/');
            if (pathSegments.length > 1) {
                const currentPath = decodeURIComponent(pathSegments[1]);
                currentPathInput.value = currentPath;
                newFolderPathInput.value = currentPath;
            } else {
                currentPathInput.value = '';
                newFolderPathInput.value = '';
            }
        });
    </script>
</body>
</html>